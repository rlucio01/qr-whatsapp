<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UAZAPI ‚Äî Debug Inspector</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #06100a; --card: #101f15; --border: rgba(31,58,37,.5);
      --green: #25d366; --glow: rgba(37,211,102,.15);
      --text: #dff0e5; --muted: #5d8a6e;
      --danger: #f05757; --warn: #f5c842; --info: #4dc8f5;
    }
    body {
      font-family: 'DM Mono', monospace;
      background: var(--bg); color: var(--text);
      min-height: 100vh; display: flex; flex-direction: column;
      align-items: center; padding: 2rem 1rem;
    }
    h1 { font-family: 'Syne', sans-serif; font-size: 1.3rem; color: var(--green); margin-bottom: 1.5rem; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 1.4rem; width: 100%; max-width: 700px; margin-bottom: 1rem; }
    label { display: block; font-size: .72rem; color: var(--muted); margin-bottom: .3rem; }
    input, select {
      width: 100%; background: #0d1e12; border: 1px solid var(--border);
      border-radius: 8px; padding: .6rem .85rem; color: var(--text);
      font-family: 'DM Mono', monospace; font-size: .82rem; outline: none; margin-bottom: .8rem;
    }
    input:focus { border-color: var(--green); }
    .row { display: flex; gap: .6rem; margin-bottom: .8rem; }
    .row input, .row select { margin-bottom: 0; }
    .row select { width: 90px; flex-shrink: 0; }

    .btn {
      width: 100%; padding: .75rem; border-radius: 9px; border: none; cursor: pointer;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: .88rem;
      background: var(--green); color: #04100a; margin-bottom: .5rem;
      transition: opacity .2s;
    }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); font-size: .8rem; }
    .btn-ghost:hover { color: var(--text); }

    /* results */
    .results { width: 100%; max-width: 700px; }
    .result-block {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; margin-bottom: .75rem; overflow: hidden;
    }
    .result-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: .6rem 1rem; font-size: .75rem; border-bottom: 1px solid var(--border);
    }
    .result-head .method { font-weight: 700; margin-right: .5rem; }
    .result-head .url { color: var(--muted); font-size: .7rem; word-break: break-all; }
    .badge { padding: .15rem .5rem; border-radius: 4px; font-size: .7rem; font-weight: 700; flex-shrink: 0; }
    .badge.s200 { background: rgba(37,211,102,.2); color: var(--green); }
    .badge.s4xx { background: rgba(240,87,87,.2); color: var(--danger); }
    .badge.serr { background: rgba(245,200,66,.2); color: var(--warn); }
    .badge.sqr  { background: rgba(37,211,102,.35); color: #fff; }

    .result-body { padding: .75rem 1rem; }
    pre {
      font-family: 'DM Mono', monospace; font-size: .72rem; line-height: 1.6;
      color: var(--text); white-space: pre-wrap; word-break: break-all;
      max-height: 220px; overflow-y: auto;
    }
    .qr-found { padding: .5rem; text-align: center; }
    .qr-found p { font-size: .8rem; color: var(--green); margin-bottom: .75rem; font-weight: 700; }

    .tip { font-size: .72rem; color: var(--info); background: rgba(77,200,245,.07); border: 1px solid rgba(77,200,245,.2); border-radius: 8px; padding: .65rem .9rem; margin-bottom: 1rem; line-height: 1.7; }
    .tip b { color: #a0e4ff; }
  </style>
</head>
<body>

<h1>üîç UAZAPI Debug Inspector</h1>

<div class="tip">
  Esta p√°gina testa <b>todos os endpoints</b> da UAZAPI e mostra o JSON bruto retornado,<br>
  permitindo identificar exatamente qual endpoint e campo cont√©m o QR Code.
</div>

<div class="card">
  <label>URL Base da API</label>
  <input id="fUrl" value="https://free.uazapi.com" />

  <label>Token da Inst√¢ncia</label>
  <input id="fToken" type="password" placeholder="e526fbf9-7a04-..." />

  <label>Corpo do POST (JSON)</label>
  <input id="fBody" value="{}" />

  <button class="btn" id="btnRun" onclick="runAll()">‚ñ∂ Testar todos os endpoints</button>
  <button class="btn btn-ghost" onclick="document.getElementById('results').innerHTML=''">‚úï Limpar resultados</button>
</div>

<div class="results" id="results"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const ENDPOINTS = [
  // UAZAPI v2 ‚Äî candidatos mais prov√°veis
  { m:'POST', p:'/instance/connect'          },
  { m:'GET',  p:'/instance/connect'          },
  { m:'GET',  p:'/instance/status'           },
  { m:'GET',  p:'/instance/qr'              },
  { m:'GET',  p:'/instance/qrcode'          },
  { m:'GET',  p:'/instance/info'            },
  { m:'POST', p:'/instance/qrcode'          },
  // Varia√ß√µes sem prefixo /instance
  { m:'GET',  p:'/qr'                       },
  { m:'POST', p:'/connect'                  },
  { m:'GET',  p:'/status'                   },
  // Varia√ß√µes com nome da inst√¢ncia no path
  { m:'GET',  p:'/qr/base64'               },
  { m:'POST', p:'/session/connect'          },
  { m:'GET',  p:'/session/qr'              },
  { m:'GET',  p:'/session/status'          },
];

function extrairQR(data) {
  if (typeof data === 'string' && data.length > 20) return data;
  const walk = (obj, depth=0) => {
    if (depth > 4 || !obj) return null;
    if (typeof obj === 'string' && obj.length > 20 &&
        (obj.includes(',') || obj.startsWith('data:') || obj.match(/^[A-Za-z0-9+/=]{40,}/)))
      return obj;
    if (typeof obj === 'object') {
      for (const v of Object.values(obj)) { const r = walk(v, depth+1); if (r) return r; }
    }
    return null;
  };
  return walk(data);
}

async function testar(url, method, body, token) {
  try {
    const opts = {
      method,
      headers: { 'Content-Type': 'application/json', 'token': token },
    };
    if (method === 'POST') opts.body = body;

    const ctrl = new AbortController();
    setTimeout(() => ctrl.abort(), 10000);
    opts.signal = ctrl.signal;

    const r   = await fetch(url, opts);
    const txt = await r.text();
    let parsed;
    try { parsed = JSON.parse(txt); } catch { parsed = null; }

    const qr = extrairQR(parsed || txt);
    return { status: r.status, raw: txt, parsed, qr };
  } catch(e) {
    return { status: 0, raw: e.message, parsed: null, qr: null, isErr: true };
  }
}

async function runAll() {
  const base   = document.getElementById('fUrl').value.trim().replace(/\/+$/,'');
  const token  = document.getElementById('fToken').value.trim();
  const body   = document.getElementById('fBody').value.trim();
  const out    = document.getElementById('results');

  if (!token) { alert('Informe o Token.'); return; }

  document.getElementById('btnRun').disabled = true;
  out.innerHTML = '<p style="color:var(--muted);font-size:.78rem;margin-bottom:.5rem">Testando endpoints‚Ä¶</p>';

  for (const ep of ENDPOINTS) {
    const fullUrl = base + ep.p;
    const res     = await testar(fullUrl, ep.m, body, token);

    let badgeCls = 'serr', badgeTxt = 'ERRO';
    if (res.status >= 200 && res.status < 300) { badgeCls='s200'; badgeTxt=res.status; }
    else if (res.status >= 400)                { badgeCls='s4xx'; badgeTxt=res.status; }
    if (res.qr)                                { badgeCls='sqr';  badgeTxt='‚úÖ QR!'; }

    let prettyBody = '';
    try { prettyBody = JSON.stringify(JSON.parse(res.raw), null, 2); } catch { prettyBody = res.raw; }

    let qrHtml = '';
    if (res.qr) {
      const divId = 'qr_' + Math.random().toString(36).slice(2);
      qrHtml = `<div class="qr-found">
        <p>üéâ QR encontrado neste campo! Campo: detectado automaticamente</p>
        <div id="${divId}" style="display:inline-block;background:#fff;padding:12px;border-radius:8px;"></div>
      </div>`;
      setTimeout(() => {
        const val = res.qr.startsWith('data:')
          ? null  // √© imagem base64, exibir como <img>
          : res.qr;

        if (!val) {
          document.getElementById(divId).innerHTML =
            `<img src="${res.qr}" style="width:200px;height:200px;border-radius:6px;" />`;
        } else {
          try { new QRCode(document.getElementById(divId), { text: val, width:200, height:200 }); }
          catch {}
        }
      }, 100);
    }

    const block = document.createElement('div');
    block.className = 'result-block';
    block.innerHTML = `
      <div class="result-head">
        <div>
          <span class="method">${ep.m}</span>
          <span class="url">${ep.p}</span>
        </div>
        <span class="badge ${badgeCls}">${badgeTxt}</span>
      </div>
      <div class="result-body">
        ${qrHtml}
        <pre>${escHtml(prettyBody)}</pre>
      </div>`;
    out.appendChild(block);
  }

  document.getElementById('btnRun').disabled = false;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
