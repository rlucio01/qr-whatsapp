<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conectar WhatsApp â€” UAZAPI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:         #06100a;
      --surface:    #0d1e12;
      --card:       #101f15;
      --border:     rgba(31,58,37,.5);
      --green:      #25d366;
      --green-dim:  #1db355;
      --green-glow: rgba(37,211,102,.18);
      --text:       #dff0e5;
      --muted:      #5d8a6e;
      --danger:     #f05757;
      --warn:       #f5c842;
    }

    body {
      font-family: 'Syne', sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 2rem 1rem 3rem;
      position: relative; overflow-x: hidden;
    }
    body::before {
      content:''; position:fixed; inset:0; pointer-events:none;
      background:
        radial-gradient(ellipse 70% 50% at 50% -10%, rgba(13,74,34,.35) 0%, transparent 65%),
        radial-gradient(ellipse 40% 30% at 90% 90%,  rgba(13,58,26,.2)  0%, transparent 60%);
    }
    .grid-bg {
      position:fixed; inset:0; pointer-events:none;
      background-image:
        linear-gradient(rgba(37,211,102,.055) 1px, transparent 1px),
        linear-gradient(90deg, rgba(37,211,102,.055) 1px, transparent 1px);
      background-size: 52px 52px;
    }

    .container { width:100%; max-width:440px; position:relative; z-index:1; }

    /* header */
    .header { text-align:center; margin-bottom:1.75rem; animation: fadeDown .5s ease both; }
    .brand  { display:inline-flex; align-items:center; gap:.65rem; margin-bottom:.9rem; }
    .brand-ico {
      width:44px; height:44px;
      background:var(--green-glow); border:1.5px solid var(--green);
      border-radius:12px; display:flex; align-items:center; justify-content:center;
      box-shadow:0 0 24px var(--green-glow);
    }
    .brand-ico svg { width:22px; height:22px; fill:var(--green); }
    .brand-name { font-size:1.35rem; font-weight:800; letter-spacing:-.03em; }
    .subtitle { font-size:.85rem; color:var(--muted); line-height:1.65; }

    /* card */
    .card {
      background:var(--card); border:1px solid var(--border);
      border-radius:18px; padding:1.6rem; margin-bottom:.9rem;
    }
    .card-lbl {
      font-size:.67rem; font-weight:700; letter-spacing:.12em;
      text-transform:uppercase; color:var(--green); margin-bottom:1rem;
    }

    /* form */
    .field { margin-bottom:.85rem; }
    .field label { display:block; font-size:.74rem; color:var(--muted); margin-bottom:.3rem; font-family:'DM Mono',monospace; }
    .field input {
      width:100%; background:var(--surface); border:1px solid var(--border);
      border-radius:9px; padding:.7rem .9rem; color:var(--text);
      font-family:'DM Mono',monospace; font-size:.82rem; outline:none;
      transition: border-color .2s, box-shadow .2s;
    }
    .field input:focus { border-color:var(--green); box-shadow:0 0 0 3px rgba(37,211,102,.15); }
    .field input::placeholder { color:var(--muted); opacity:.4; }

    /* buttons */
    .btn {
      width:100%; padding:.82rem 1.3rem; border-radius:10px;
      font-family:'Syne',sans-serif; font-weight:700; font-size:.88rem;
      cursor:pointer; border:none; transition:all .18s;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
    }
    .btn-primary { background:var(--green); color:#04100a; box-shadow:0 4px 20px var(--green-glow); }
    .btn-primary:hover:not(:disabled) { background:var(--green-dim); transform:translateY(-1px); }
    .btn-primary:disabled { opacity:.4; cursor:not-allowed; }
    .btn-ghost {
      background:transparent; color:var(--muted);
      border:1px solid var(--border); margin-top:.55rem; font-size:.8rem;
    }
    .btn-ghost:hover { color:var(--text); border-color:var(--muted); }

    /* status */
    .status {
      display:flex; align-items:center; gap:.55rem;
      padding:.65rem 1rem; border-radius:9px; border:1px solid transparent;
      font-family:'DM Mono',monospace; font-size:.76rem; margin-bottom:.9rem;
    }
    .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
    .status.loading { background:rgba(255,255,255,.04); border-color:var(--border); color:var(--muted); }
    .status.loading .dot { background:var(--muted); animation:blink 1s infinite; }
    .status.ok   { background:rgba(37,211,102,.08);  border-color:rgba(37,211,102,.3); color:var(--green); }
    .status.ok   .dot { background:var(--green); }
    .status.err  { background:rgba(240,87,87,.08);   border-color:rgba(240,87,87,.3);  color:var(--danger); }
    .status.err  .dot { background:var(--danger); }
    .status.live { background:rgba(245,200,66,.08);  border-color:rgba(245,200,66,.3); color:var(--warn); }
    .status.live .dot { background:var(--warn); animation:blink 1.3s infinite; }

    /* QR */
    .qr-wrap { display:flex; flex-direction:column; align-items:center; gap:1.2rem; }
    .qr-box  {
      background:#fff; border-radius:14px; padding:1.05rem;
      box-shadow:0 0 50px var(--green-glow);
    }
    .qr-box img { display:block; width:240px; height:240px; border-radius:6px; }
    .qr-meta { text-align:center; }
    .qr-meta p { font-size:.82rem; color:var(--muted); line-height:1.7; }
    .qr-meta strong { color:var(--text); }
    .timer {
      display:inline-flex; align-items:center; gap:.35rem; margin-top:.45rem;
      padding:.28rem .7rem; background:var(--surface); border:1px solid var(--border);
      border-radius:99px; font-family:'DM Mono',monospace; font-size:.73rem; color:var(--warn);
    }

    /* info box */
    .box-info {
      background:rgba(77,200,245,.07); border:1px solid rgba(77,200,245,.25);
      border-radius:9px; padding:.7rem .9rem;
      font-family:'DM Mono',monospace; font-size:.72rem; color:#7dd8f7;
      margin-top:.75rem; line-height:1.75;
    }
    .box-info b { color:#a0e4ff; }
    .box-info code {
      background:rgba(255,255,255,.08); padding:.1rem .3rem;
      border-radius:4px; font-size:.68rem; word-break:break-all;
    }

    /* success */
    .check-wrap {
      width:240px; height:240px;
      display:flex; align-items:center; justify-content:center;
      background:#f0fdf4; border-radius:8px;
    }
    .check-wrap svg { width:88px; height:88px; }

    .footer { margin-top:1.25rem; text-align:center; font-size:.7rem; color:var(--muted); opacity:.4; }

    .hidden { display:none !important; }

    @keyframes fadeDown { from{opacity:0;transform:translateY(-12px)} to{opacity:1;transform:translateY(0)} }
    @keyframes blink    { 0%,100%{opacity:1} 50%{opacity:.2} }
    @keyframes spin     { to{transform:rotate(360deg)} }
  </style>
</head>
<body>
<div class="grid-bg"></div>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <div class="brand-ico">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51a12.6 12.6 0 00-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      </div>
      <span class="brand-name">Conectar WhatsApp</span>
    </div>
    <p class="subtitle">Escaneie o QR Code para vincular seu nÃºmero<br>a esta instÃ¢ncia UAZAPI.</p>
  </div>

  <!-- STATUS -->
  <div class="status hidden" id="statusBar">
    <div class="dot"></div>
    <span id="statusTxt"></span>
  </div>

  <!-- CONFIG CARD -->
  <div class="card" id="cfgCard">
    <div class="card-lbl">âš™ ConfiguraÃ§Ã£o da instÃ¢ncia</div>
    <div class="field">
      <label>URL Base da API</label>
      <input id="fUrl" type="text" placeholder="https://free.uazapi.com" autocomplete="off" />
    </div>
    <div class="field">
      <label>Token da InstÃ¢ncia</label>
      <input id="fToken" type="password" placeholder="e526fbf9-7a04-4693-aeb7-0ebae75aefc2" autocomplete="off" />
    </div>
    <button class="btn btn-primary" id="btnGo" onclick="iniciar()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
      Gerar QR Code
    </button>
    <div class="box-info">
      ğŸ’¡ <b>Compartilhe o link jÃ¡ configurado:</b><br>
      <code id="linkShare"></code>
    </div>
  </div>

  <!-- QR CARD -->
  <div class="card hidden" id="qrCard">
    <div class="card-lbl">ğŸ“± Escaneie com o WhatsApp</div>
    <div class="qr-wrap">
      <div class="qr-box" id="qrBox">
        <!-- imagem QR inserida aqui -->
      </div>
      <div class="qr-meta">
        <p>Abra o WhatsApp â†’ <strong>ConfiguraÃ§Ãµes</strong><br>
          â†’ <strong>Aparelhos conectados â†’ Conectar aparelho</strong></p>
        <div class="timer hidden" id="timerBadge">
          â± Expira em <span id="countdown">60</span>s
        </div>
      </div>
    </div>
    <button class="btn btn-ghost" onclick="refreshQR()">â†» Atualizar QR Code</button>
    <button class="btn btn-ghost" onclick="voltarCfg()">â† Alterar configuraÃ§Ãµes</button>
  </div>

  <div class="footer">Powered by UAZAPI Â· GitHub Pages</div>
</div>

<script>
// â”€â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apiUrl = '', apiToken = '';
let timerInt = null, pollInt = null, secs = 60;

// â”€â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  const p = new URLSearchParams(location.search);
  let saved = {};
  try { saved = JSON.parse(localStorage.getItem('uaz3') || '{}'); } catch {}

  $('fUrl').value   = p.get('url')   || saved.url   || '';
  $('fToken').value = p.get('token') || saved.token || '';

  atualizarLink();
  $('fUrl').addEventListener('input',   atualizarLink);
  $('fToken').addEventListener('input', atualizarLink);

  // auto-start se vier pelos parÃ¢metros de URL
  if (p.get('url') && p.get('token')) setTimeout(iniciar, 400);
});

function $(id) { return document.getElementById(id); }

function atualizarLink() {
  const base  = location.href.split('?')[0];
  const url   = $('fUrl').value.trim()   || 'https://free.uazapi.com';
  const token = $('fToken').value.trim() || 'SEU_TOKEN';
  $('linkShare').textContent = `${base}?url=${encodeURIComponent(url)}&token=${encodeURIComponent(token)}`;
}

// â”€â”€â”€ status UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(tipo, msg) {
  const bar = $('statusBar');
  bar.className = 'status ' + tipo;
  bar.classList.remove('hidden');
  $('statusTxt').textContent = msg;
}

// â”€â”€â”€ fetch com timeout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(url, opts = {}) {
  const ctrl = new AbortController();
  const tid  = setTimeout(() => ctrl.abort(), 15000);
  try {
    const r = await fetch(url, { ...opts, signal: ctrl.signal });
    clearTimeout(tid);
    return r;
  } catch(e) { clearTimeout(tid); throw e; }
}

// â”€â”€â”€ buscar QR â€” endpoints confirmados pelo debug â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Confirmado: POST /instance/connect e GET /instance/status retornam
//   { instance: { qrcode: "data:image/png;base64,..." } }
async function buscarQR() {
  const base = apiUrl.replace(/\/+$/, '');
  const hdrs = { 'Content-Type': 'application/json', 'token': apiToken };

  // 1Âº: POST /instance/connect (mais rÃ¡pido, sempre retorna QR fresco)
  try {
    const r = await apiFetch(`${base}/instance/connect`, {
      method: 'POST',
      headers: hdrs,
      body: '{}',
    });
    const data = await r.json();
    const qr = extrairQR(data);
    if (qr) return qr;
  } catch(e) { console.warn('POST /instance/connect falhou:', e.message); }

  // 2Âº: GET /instance/status (fallback â€” tambÃ©m traz qrcode enquanto desconectado)
  try {
    const r = await apiFetch(`${base}/instance/status`, {
      method: 'GET',
      headers: hdrs,
    });
    const data = await r.json();
    const qr = extrairQR(data);
    if (qr) return qr;
  } catch(e) { console.warn('GET /instance/status falhou:', e.message); }

  throw new Error('Nenhum endpoint retornou QR Code.');
}

// â”€â”€â”€ extrair QR do JSON retornado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Estrutura confirmada: data.instance.qrcode = "data:image/png;base64,..."
function extrairQR(data) {
  // Caminho principal confirmado
  if (data?.instance?.qrcode) return data.instance.qrcode;

  // Caminhos alternativos por seguranÃ§a
  const candidates = [
    data?.qrcode, data?.qr, data?.qrCode,
    data?.data?.qrcode, data?.data?.qr, data?.data?.qrCode,
    data?.result?.qrcode, data?.result?.qr,
  ];
  for (const c of candidates) {
    if (c && typeof c === 'string' && c.length > 20) return c;
  }
  return null;
}

// â”€â”€â”€ renderizar QR Code (base64 PNG) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQR(base64png) {
  const box = $('qrBox');
  box.innerHTML = `<img src="${base64png}" alt="QR Code WhatsApp" />`;

  // timer regressivo de 60s
  secs = 60;
  $('countdown').textContent = secs;
  $('timerBadge').classList.remove('hidden');
  clearInterval(timerInt);
  timerInt = setInterval(() => {
    secs--;
    $('countdown').textContent = secs;
    if (secs <= 0) { clearInterval(timerInt); refreshQR(); }
  }, 1000);
}

// â”€â”€â”€ INICIAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function iniciar() {
  apiUrl   = $('fUrl').value.trim();
  apiToken = $('fToken').value.trim();

  if (!apiUrl)   { alert('Informe a URL da API.'); return; }
  if (!apiToken) { alert('Informe o Token da instÃ¢ncia.'); return; }
  if (!apiUrl.startsWith('http')) apiUrl = 'https://' + apiUrl;

  try { localStorage.setItem('uaz3', JSON.stringify({ url: apiUrl, token: apiToken })); } catch {}

  $('btnGo').disabled = true;
  setStatus('loading', 'Gerando QR Codeâ€¦');

  try {
    const qr = await buscarQR();
    $('cfgCard').classList.add('hidden');
    $('qrCard').classList.remove('hidden');
    setStatus('ok', 'QR Code pronto! Escaneie agora.');
    renderQR(qr);
    iniciarPolling();
  } catch(e) {
    $('btnGo').disabled = false;
    console.error(e);

    const isCors = e instanceof TypeError && e.message === 'Failed to fetch';
    if (isCors) {
      setStatus('err', 'Erro de rede (CORS). A API bloqueou a requisiÃ§Ã£o do navegador.');
    } else {
      setStatus('err', 'NÃ£o foi possÃ­vel obter o QR. Verifique URL e Token.');
    }
  }
}

// â”€â”€â”€ REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshQR() {
  clearInterval(timerInt);
  setStatus('loading', 'Atualizando QR Codeâ€¦');
  try {
    const qr = await buscarQR();
    setStatus('ok', 'QR atualizado! Escaneie agora.');
    renderQR(qr);
  } catch {
    setStatus('err', 'Falha ao atualizar. Tentando novamente em 5sâ€¦');
    setTimeout(refreshQR, 5000);
  }
}

// â”€â”€â”€ POLLING de conexÃ£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Confirmado: GET /status retorna checked_instance.connection_status = "connected"
function iniciarPolling() {
  clearInterval(pollInt);
  const base = apiUrl.replace(/\/+$/, '');
  const hdrs = { 'Content-Type': 'application/json', 'token': apiToken };

  pollInt = setInterval(async () => {
    try {
      // Endpoint de status do servidor (confirmado: GET /status â†’ 200)
      const r = await apiFetch(`${base}/status`, { headers: hdrs });
      if (!r.ok) return;
      const data = await r.json();

      // Campo confirmado: checked_instance.connection_status = "connected"
      const connStatus = (
        data?.checked_instance?.connection_status ||
        data?.instance?.status ||
        data?.status || ''
      ).toString().toLowerCase();

      if (connStatus === 'connected' || connStatus === 'open' || connStatus === 'online') {
        clearInterval(pollInt);
        clearInterval(timerInt);
        setStatus('live', 'âœ… WhatsApp conectado com sucesso!');
        $('qrBox').innerHTML = `
          <div class="check-wrap">
            <svg viewBox="0 0 52 52" fill="none">
              <circle cx="26" cy="26" r="25" fill="#dcfce7" stroke="#25d366" stroke-width="2"/>
              <path d="M15 26l8 8 14-16" stroke="#25d366" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>`;
        $('timerBadge').classList.add('hidden');
      }
    } catch { /* ignora erros de rede no poll */ }
  }, 4000);
}

// â”€â”€â”€ VOLTAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function voltarCfg() {
  clearInterval(pollInt); clearInterval(timerInt);
  $('cfgCard').classList.remove('hidden');
  $('qrCard').classList.add('hidden');
  $('statusBar').classList.add('hidden');
  $('btnGo').disabled = false;
}
</script>
</body>
</html>
