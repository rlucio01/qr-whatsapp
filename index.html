<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conectar WhatsApp â€” UAZAPI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:         #06100a;
      --surface:    #0d1e12;
      --card:       #101f15;
      --border:     rgba(31,58,37,.5);
      --green:      #25d366;
      --green-dim:  #1db355;
      --green-glow: rgba(37,211,102,.18);
      --text:       #dff0e5;
      --muted:      #5d8a6e;
      --danger:     #f05757;
      --warn:       #f5c842;
    }

    body {
      font-family: 'Syne', sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 2rem 1rem 3rem;
      position: relative; overflow-x: hidden;
    }
    body::before {
      content: ''; position: fixed; inset: 0; pointer-events: none;
      background:
        radial-gradient(ellipse 70% 50% at 50% -10%, rgba(13,74,34,.35) 0%, transparent 65%),
        radial-gradient(ellipse 40% 30% at 90% 90%,  rgba(13,58,26,.2)  0%, transparent 60%);
    }
    .grid-bg {
      position: fixed; inset: 0; pointer-events: none;
      background-image:
        linear-gradient(rgba(37,211,102,.055) 1px, transparent 1px),
        linear-gradient(90deg, rgba(37,211,102,.055) 1px, transparent 1px);
      background-size: 52px 52px;
    }

    .container { width: 100%; max-width: 440px; position: relative; z-index: 1; }

    /* â”€â”€ header â”€â”€ */
    .header { text-align: center; margin-bottom: 1.75rem; animation: fadeDown .5s ease both; }
    .brand  { display: inline-flex; align-items: center; gap: .65rem; margin-bottom: .9rem; }
    .brand-ico {
      width: 44px; height: 44px;
      background: var(--green-glow); border: 1.5px solid var(--green);
      border-radius: 12px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 24px var(--green-glow);
    }
    .brand-ico svg { width: 22px; height: 22px; fill: var(--green); }
    .brand-name { font-size: 1.35rem; font-weight: 800; letter-spacing: -.03em; }
    .subtitle { font-size: .85rem; color: var(--muted); line-height: 1.65; }

    /* â”€â”€ card â”€â”€ */
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 18px; padding: 1.6rem; margin-bottom: .9rem;
    }
    .card-lbl {
      font-size: .67rem; font-weight: 700; letter-spacing: .12em;
      text-transform: uppercase; color: var(--green); margin-bottom: 1rem;
    }

    /* â”€â”€ form â”€â”€ */
    .field { margin-bottom: .85rem; }
    .field label { display: block; font-size: .74rem; color: var(--muted); margin-bottom: .3rem; font-family: 'DM Mono', monospace; }
    .field input {
      width: 100%; background: var(--surface); border: 1px solid var(--border);
      border-radius: 9px; padding: .7rem .9rem; color: var(--text);
      font-family: 'DM Mono', monospace; font-size: .82rem; outline: none;
      transition: border-color .2s, box-shadow .2s;
    }
    .field input:focus { border-color: var(--green); box-shadow: 0 0 0 3px rgba(37,211,102,.15); }
    .field input::placeholder { color: var(--muted); opacity: .4; }

    /* â”€â”€ buttons â”€â”€ */
    .btn {
      width: 100%; padding: .82rem 1.3rem; border-radius: 10px;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: .88rem;
      cursor: pointer; border: none; transition: all .18s;
      display: flex; align-items: center; justify-content: center; gap: .5rem;
    }
    .btn-primary { background: var(--green); color: #04100a; box-shadow: 0 4px 20px var(--green-glow); }
    .btn-primary:hover:not(:disabled) { background: var(--green-dim); transform: translateY(-1px); }
    .btn-primary:disabled { opacity: .4; cursor: not-allowed; }
    .btn-ghost {
      background: transparent; color: var(--muted);
      border: 1px solid var(--border); margin-top: .55rem; font-size: .8rem;
    }
    .btn-ghost:hover { color: var(--text); border-color: var(--muted); }

    /* â”€â”€ status â”€â”€ */
    .status {
      display: flex; align-items: center; gap: .55rem;
      padding: .65rem 1rem; border-radius: 9px; border: 1px solid transparent;
      font-family: 'DM Mono', monospace; font-size: .76rem; margin-bottom: .9rem;
    }
    .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .status.loading { background: rgba(255,255,255,.04); border-color: var(--border); color: var(--muted); }
    .status.loading .dot { background: var(--muted); animation: blink 1s infinite; }
    .status.ok   { background: rgba(37,211,102,.08); border-color: rgba(37,211,102,.3); color: var(--green); }
    .status.ok   .dot { background: var(--green); }
    .status.err  { background: rgba(240,87,87,.08);  border-color: rgba(240,87,87,.3);  color: var(--danger); }
    .status.err  .dot { background: var(--danger); }

    /* â”€â”€ share link box â”€â”€ */
    .share-box {
      background: rgba(77,200,245,.06); border: 1px solid rgba(77,200,245,.22);
      border-radius: 10px; padding: .75rem .9rem; margin-top: .8rem;
    }
    .share-label {
      font-size: .67rem; font-weight: 700; letter-spacing: .1em;
      text-transform: uppercase; color: #4dc8f5; margin-bottom: .55rem;
      display: flex; align-items: center; gap: .35rem;
    }
    .share-row { display: flex; align-items: center; gap: .45rem; }
    .share-url {
      flex: 1; background: rgba(255,255,255,.05); border: 1px solid rgba(77,200,245,.2);
      border-radius: 7px; padding: .42rem .7rem;
      font-family: 'DM Mono', monospace; font-size: .64rem; color: #7dd8f7;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      display: block; min-width: 0;
    }
    .btn-copy {
      flex-shrink: 0;
      background: rgba(37,211,102,.12); border: 1px solid rgba(37,211,102,.35);
      border-radius: 7px; padding: .42rem .85rem; cursor: pointer;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: .72rem;
      color: var(--green); white-space: nowrap; transition: all .18s;
      display: flex; align-items: center; gap: .35rem;
    }
    .btn-copy:hover { background: rgba(37,211,102,.22); }
    .btn-copy.copied {
      background: rgba(37,211,102,.3); color: #fff;
      border-color: var(--green); transform: scale(.97);
    }
    .btn-copy svg { width: 12px; height: 12px; flex-shrink: 0; }

    /* â”€â”€ QR â”€â”€ */
    .qr-wrap { display: flex; flex-direction: column; align-items: center; gap: 1.2rem; }
    .qr-box  {
      background: #fff; border-radius: 14px; padding: 1.05rem;
      box-shadow: 0 0 50px var(--green-glow); min-width: 258px; min-height: 258px;
      display: flex; align-items: center; justify-content: center;
    }
    .qr-box img { display: block; width: 240px; height: 240px; border-radius: 6px; }
    .qr-meta { text-align: center; }
    .qr-meta p { font-size: .82rem; color: var(--muted); line-height: 1.7; }
    .qr-meta strong { color: var(--text); }
    .timer {
      display: inline-flex; align-items: center; gap: .35rem; margin-top: .45rem;
      padding: .28rem .7rem; background: var(--surface); border: 1px solid var(--border);
      border-radius: 99px; font-family: 'DM Mono', monospace; font-size: .73rem; color: var(--warn);
    }

    /* â”€â”€ SUCCESS SCREEN â”€â”€ */
    .success-screen {
      display: flex; flex-direction: column; align-items: center;
      text-align: center; gap: 1.15rem; padding: .5rem 0 .75rem;
    }
    .success-aura {
      width: 108px; height: 108px; border-radius: 50%;
      background: radial-gradient(circle, rgba(37,211,102,.22) 0%, transparent 70%);
      display: flex; align-items: center; justify-content: center;
      animation: popIn .6s cubic-bezier(.34,1.56,.64,1) both;
      box-shadow: 0 0 40px rgba(37,211,102,.2);
    }
    .success-aura svg { width: 60px; height: 60px; }
    .success-title {
      font-size: 1.3rem; font-weight: 800; color: var(--green);
      letter-spacing: -.02em; line-height: 1.25;
      animation: fadeUp .45s ease .15s both;
    }
    .success-body {
      font-size: .85rem; color: var(--muted); line-height: 1.75;
      animation: fadeUp .45s ease .25s both;
    }
    .success-body strong { color: var(--text); }
    .success-pill {
      display: inline-flex; align-items: center; gap: .55rem;
      background: rgba(37,211,102,.1); border: 1px solid rgba(37,211,102,.35);
      border-radius: 99px; padding: .45rem 1.2rem;
      font-family: 'DM Mono', monospace; font-size: .76rem; color: var(--green);
      animation: fadeUp .45s ease .35s both;
    }
    .live-dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--green);
      animation: blink 1.4s infinite;
    }
    .success-divider {
      width: 40px; height: 2px;
      background: linear-gradient(90deg, transparent, var(--green), transparent);
      border-radius: 99px;
      animation: fadeUp .45s ease .2s both;
    }

    .footer { margin-top: 1.25rem; text-align: center; font-size: .7rem; color: var(--muted); opacity: .4; }

    .hidden { display: none !important; }

    @keyframes fadeDown { from{opacity:0;transform:translateY(-12px)} to{opacity:1;transform:translateY(0)} }
    @keyframes fadeUp   { from{opacity:0;transform:translateY(10px)}  to{opacity:1;transform:translateY(0)} }
    @keyframes blink    { 0%,100%{opacity:1} 50%{opacity:.2} }
    @keyframes spin     { to{transform:rotate(360deg)} }
    @keyframes popIn    { from{opacity:0;transform:scale(.35)} to{opacity:1;transform:scale(1)} }
  </style>
</head>
<body>
<div class="grid-bg"></div>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <div class="brand-ico">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51a12.6 12.6 0 00-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      </div>
      <span class="brand-name">Conectar WhatsApp</span>
    </div>
    <p class="subtitle">Escaneie o QR Code para vincular seu nÃºmero<br>a esta instÃ¢ncia UAZAPI.</p>
  </div>

  <!-- STATUS -->
  <div class="status hidden" id="statusBar">
    <div class="dot"></div>
    <span id="statusTxt"></span>
  </div>

  <!-- â•â• CONFIG CARD â•â• -->
  <div class="card" id="cfgCard">
    <div class="card-lbl">âš™ ConfiguraÃ§Ã£o da instÃ¢ncia</div>
    <div class="field">
      <label>URL Base da API</label>
      <input id="fUrl" type="text" placeholder="https://free.uazapi.com" autocomplete="off" />
    </div>
    <div class="field">
      <label>Token da InstÃ¢ncia</label>
      <input id="fToken" type="password" placeholder="e526fbf9-7a04-4693-aeb7-0ebae75aefc2" autocomplete="off" />
    </div>
    <button class="btn btn-primary" id="btnGo" onclick="iniciar()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
      Gerar QR Code
    </button>

    <!-- Share link -->
    <div class="share-box">
      <div class="share-label">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Link para compartilhar com o cliente
      </div>
      <div class="share-row">
        <span class="share-url" id="linkShare">â€”</span>
        <button class="btn-copy" id="btnCopy" onclick="copiarLink()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
          </svg>
          Copiar
        </button>
      </div>
    </div>
  </div>

  <!-- â•â• QR CARD â•â• -->
  <div class="card hidden" id="qrCard">
    <div class="card-lbl">ğŸ“± Escaneie com o WhatsApp</div>
    <div class="qr-wrap">
      <div class="qr-box" id="qrBox">
        <!-- QR inserido aqui -->
      </div>
      <div class="qr-meta">
        <p>Abra o WhatsApp â†’ <strong>ConfiguraÃ§Ãµes</strong><br>
          â†’ <strong>Aparelhos conectados â†’ Conectar aparelho</strong></p>
        <div class="timer hidden" id="timerBadge">
          â± Expira em <span id="countdown">60</span>s
        </div>
      </div>
    </div>
    <button class="btn btn-ghost" onclick="refreshQR()">â†» Atualizar QR Code</button>
    <button class="btn btn-ghost" onclick="voltarCfg()">â† Alterar configuraÃ§Ãµes</button>
  </div>

  <!-- â•â• SUCCESS CARD â•â• -->
  <div class="card hidden" id="successCard">
    <div class="success-screen">

      <div class="success-aura">
        <svg viewBox="0 0 64 64" fill="none">
          <circle cx="32" cy="32" r="31" fill="#dcfce7" stroke="#25d366" stroke-width="2"/>
          <path d="M18 32l10 10 18-20" stroke="#25d366" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="success-title">WhatsApp conectado!</div>

      <div class="success-divider"></div>

      <div class="success-body">
        Seu dispositivo foi vinculado com sucesso.<br>
        <strong>VocÃª jÃ¡ pode fechar esta pÃ¡gina.</strong>
      </div>

      <div class="success-pill">
        <span class="live-dot"></span>
        InstÃ¢ncia online e pronta para uso
      </div>

    </div>
  </div>

  <div class="footer">Powered by UAZAPI Â· GitHub Pages</div>
</div>

<script>
// â”€â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apiUrl = '', apiToken = '';
let timerInt = null, pollInt = null, secs = 60;

// â”€â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  const p = new URLSearchParams(location.search);
  let saved = {};
  try { saved = JSON.parse(localStorage.getItem('uaz3') || '{}'); } catch {}

  $('fUrl').value   = p.get('url')   || saved.url   || '';
  $('fToken').value = p.get('token') || saved.token || '';

  atualizarLink();
  $('fUrl').addEventListener('input',   atualizarLink);
  $('fToken').addEventListener('input', atualizarLink);

  if (p.get('url') && p.get('token')) setTimeout(iniciar, 400);
});

function $(id) { return document.getElementById(id); }

// â”€â”€â”€ gerar link compartilhÃ¡vel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function atualizarLink() {
  const base  = location.href.split('?')[0];
  const url   = $('fUrl').value.trim()   || 'https://free.uazapi.com';
  const token = $('fToken').value.trim() || 'SEU_TOKEN';
  const link  = `${base}?url=${encodeURIComponent(url)}&token=${encodeURIComponent(token)}`;
  $('linkShare').textContent = link;
  $('linkShare').dataset.link = link;
}

// â”€â”€â”€ copiar link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copiarLink() {
  const link = $('linkShare').dataset.link || $('linkShare').textContent;
  navigator.clipboard.writeText(link).then(() => {
    const btn = $('btnCopy');
    btn.classList.add('copied');
    btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      Copiado!`;
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px">
          <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
        </svg>
        Copiar`;
    }, 2200);
  }).catch(() => {
    // fallback para browsers sem clipboard API
    const el = document.createElement('textarea');
    el.value = link;
    el.style.cssText = 'position:fixed;opacity:0';
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    const btn = $('btnCopy');
    btn.classList.add('copied');
    btn.textContent = 'âœ“ Copiado!';
    setTimeout(() => { btn.classList.remove('copied'); btn.textContent = 'Copiar'; }, 2200);
  });
}

// â”€â”€â”€ status UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(tipo, msg) {
  const bar = $('statusBar');
  bar.className = 'status ' + tipo;
  bar.classList.remove('hidden');
  $('statusTxt').textContent = msg;
}

// â”€â”€â”€ fetch com timeout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(url, opts = {}) {
  const ctrl = new AbortController();
  const tid  = setTimeout(() => ctrl.abort(), 15000);
  try {
    const r = await fetch(url, { ...opts, signal: ctrl.signal });
    clearTimeout(tid); return r;
  } catch(e) { clearTimeout(tid); throw e; }
}

// â”€â”€â”€ buscar QR â€” endpoints confirmados â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buscarQR() {
  const base = apiUrl.replace(/\/+$/, '');
  const hdrs = { 'Content-Type': 'application/json', 'token': apiToken };

  // 1Âº: POST /instance/connect (retorna QR fresco)
  try {
    const r    = await apiFetch(`${base}/instance/connect`, { method: 'POST', headers: hdrs, body: '{}' });
    const data = await r.json();
    const qr   = extrairQR(data);
    if (qr) return qr;
  } catch(e) { console.warn('POST /instance/connect:', e.message); }

  // 2Âº: GET /instance/status (fallback)
  try {
    const r    = await apiFetch(`${base}/instance/status`, { method: 'GET', headers: hdrs });
    const data = await r.json();
    const qr   = extrairQR(data);
    if (qr) return qr;
  } catch(e) { console.warn('GET /instance/status:', e.message); }

  throw new Error('Nenhum endpoint retornou QR Code.');
}

// â”€â”€â”€ extrair campo qrcode da resposta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Confirmado: { instance: { qrcode: "data:image/png;base64,..." } }
function extrairQR(data) {
  if (data?.instance?.qrcode) return data.instance.qrcode;
  const c = [data?.qrcode, data?.qr, data?.qrCode,
    data?.data?.qrcode, data?.data?.qr, data?.result?.qr];
  for (const v of c) if (v && typeof v === 'string' && v.length > 20) return v;
  return null;
}

// â”€â”€â”€ renderizar QR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQR(base64png) {
  $('qrBox').innerHTML = `<img src="${base64png}" alt="QR Code WhatsApp" />`;
  secs = 60;
  $('countdown').textContent = secs;
  $('timerBadge').classList.remove('hidden');
  clearInterval(timerInt);
  timerInt = setInterval(() => {
    secs--;
    $('countdown').textContent = secs;
    if (secs <= 0) { clearInterval(timerInt); refreshQR(); }
  }, 1000);
}

// â”€â”€â”€ INICIAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function iniciar() {
  apiUrl   = $('fUrl').value.trim();
  apiToken = $('fToken').value.trim();

  if (!apiUrl)   { alert('Informe a URL da API.');          return; }
  if (!apiToken) { alert('Informe o Token da instÃ¢ncia.');  return; }
  if (!apiUrl.startsWith('http')) apiUrl = 'https://' + apiUrl;

  try { localStorage.setItem('uaz3', JSON.stringify({ url: apiUrl, token: apiToken })); } catch {}

  $('btnGo').disabled = true;
  setStatus('loading', 'Gerando QR Codeâ€¦');

  try {
    const qr = await buscarQR();
    $('cfgCard').classList.add('hidden');
    $('qrCard').classList.remove('hidden');
    setStatus('ok', 'QR Code pronto! Escaneie agora.');
    renderQR(qr);
    iniciarPolling();
  } catch(e) {
    $('btnGo').disabled = false;
    console.error(e);
    const isCors = e instanceof TypeError && e.message === 'Failed to fetch';
    setStatus('err', isCors
      ? 'Erro de rede (CORS). A API bloqueou a requisiÃ§Ã£o do navegador.'
      : 'NÃ£o foi possÃ­vel obter o QR. Verifique URL e Token.');
  }
}

// â”€â”€â”€ REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshQR() {
  clearInterval(timerInt);
  setStatus('loading', 'Atualizando QR Codeâ€¦');
  try {
    const qr = await buscarQR();
    setStatus('ok', 'QR atualizado! Escaneie agora.');
    renderQR(qr);
  } catch {
    setStatus('err', 'Falha ao atualizar. Tentando em 5sâ€¦');
    setTimeout(refreshQR, 5000);
  }
}

// â”€â”€â”€ POLLING de conexÃ£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GET /status â†’ checked_instance.connection_status === "connected"
function iniciarPolling() {
  clearInterval(pollInt);
  const base = apiUrl.replace(/\/+$/, '');
  const hdrs = { 'Content-Type': 'application/json', 'token': apiToken };

  pollInt = setInterval(async () => {
    try {
      const r = await apiFetch(`${base}/status`, { headers: hdrs });
      if (!r.ok) return;
      const data = await r.json();

      const connStatus = (
        data?.checked_instance?.connection_status ||
        data?.instance?.status ||
        data?.status || ''
      ).toString().toLowerCase();

      if (['connected', 'open', 'online'].includes(connStatus)) {
        mostrarSucesso();
      }
    } catch { /* ignora erros de rede */ }
  }, 4000);
}

// â”€â”€â”€ TELA DE SUCESSO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mostrarSucesso() {
  clearInterval(pollInt);
  clearInterval(timerInt);

  // Esconde QR e status, mostra card de sucesso
  $('qrCard').classList.add('hidden');
  $('statusBar').classList.add('hidden');
  $('successCard').classList.remove('hidden');

  // Scroll suave para o topo
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// â”€â”€â”€ VOLTAR CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function voltarCfg() {
  clearInterval(pollInt); clearInterval(timerInt);
  $('cfgCard').classList.remove('hidden');
  $('qrCard').classList.add('hidden');
  $('successCard').classList.add('hidden');
  $('statusBar').classList.add('hidden');
  $('btnGo').disabled = false;
}
</script>
</body>
</html>
