<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conectar WhatsApp ‚Äî UAZAPI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #06100a;
      --surface: #0d1e12;
      --card: #101f15;
      --border: #1f3a2580;
      --green: #25d366;
      --green-dim: #1db355;
      --green-glow: #25d36628;
      --text: #dff0e5;
      --muted: #5d8a6e;
      --danger: #f05757;
      --warning: #f5c842;
    }

    body {
      font-family: 'Syne', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 2rem 1rem 3rem;
      position: relative; overflow-x: hidden;
    }

    body::before {
      content: ''; position: fixed; inset: 0;
      background:
        radial-gradient(ellipse 70% 50% at 50% -10%, #0d4a2255 0%, transparent 65%),
        radial-gradient(ellipse 40% 30% at 90% 90%, #0d3a1a22 0%, transparent 60%);
      pointer-events: none; z-index: 0;
    }

    .grid {
      position: fixed; inset: 0;
      background-image:
        linear-gradient(rgba(37,211,102,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(37,211,102,.06) 1px, transparent 1px);
      background-size: 52px 52px;
      pointer-events: none; z-index: 0;
    }

    .container { width: 100%; max-width: 480px; position: relative; z-index: 1; }

    /* HEADER */
    .header { text-align: center; margin-bottom: 2rem; animation: fadeDown .55s ease both; }
    .brand { display: inline-flex; align-items: center; gap: .7rem; margin-bottom: 1rem; }
    .brand-icon {
      width: 46px; height: 46px;
      background: var(--green-glow); border: 1.5px solid var(--green);
      border-radius: 13px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 28px var(--green-glow);
    }
    .brand-icon svg { width: 24px; height: 24px; fill: var(--green); }
    .brand-name { font-size: 1.4rem; font-weight: 800; letter-spacing: -.03em; }
    .subtitle { font-size: .875rem; color: var(--muted); line-height: 1.65; font-weight: 400; }

    /* CARD */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 1.75rem; margin-bottom: 1rem; }
    .card-label { font-size: .68rem; font-weight: 700; letter-spacing: .12em; text-transform: uppercase; color: var(--green); margin-bottom: 1.1rem; }

    /* FORM */
    .field { margin-bottom: .9rem; }
    .field label { display: block; font-size: .75rem; color: var(--muted); margin-bottom: .35rem; font-family: 'DM Mono', monospace; }
    .field input {
      width: 100%; background: var(--surface); border: 1px solid var(--border);
      border-radius: 9px; padding: .72rem .95rem; color: var(--text);
      font-family: 'DM Mono', monospace; font-size: .83rem; outline: none;
      transition: border-color .2s, box-shadow .2s;
    }
    .field input:focus { border-color: var(--green); box-shadow: 0 0 0 3px var(--green-glow); }
    .field input::placeholder { color: var(--muted); opacity: .45; }

    /* BUTTONS */
    .btn {
      width: 100%; padding: .85rem 1.4rem; border-radius: 11px;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: .9rem;
      cursor: pointer; border: none; transition: all .2s;
      display: flex; align-items: center; justify-content: center; gap: .55rem; letter-spacing: .02em;
    }
    .btn-primary { background: var(--green); color: #04100a; box-shadow: 0 4px 22px var(--green-glow); }
    .btn-primary:hover:not(:disabled) { background: var(--green-dim); transform: translateY(-1px); box-shadow: 0 6px 30px var(--green-glow); }
    .btn-primary:active:not(:disabled) { transform: translateY(0); }
    .btn-primary:disabled { opacity: .45; cursor: not-allowed; }
    .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); margin-top: .6rem; font-size: .82rem; }
    .btn-ghost:hover { color: var(--text); border-color: var(--muted); }

    /* STATUS */
    .status {
      display: flex; align-items: center; gap: .6rem;
      padding: .7rem 1.1rem; border-radius: 9px; border: 1px solid transparent;
      font-family: 'DM Mono', monospace; font-size: .78rem; margin-bottom: 1rem;
    }
    .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .status.loading { background: #ffffff08; border-color: var(--border); color: var(--muted); }
    .status.loading .dot { background: var(--muted); animation: blink 1s infinite; }
    .status.ok { background: #25d36614; border-color: #25d36640; color: var(--green); }
    .status.ok .dot { background: var(--green); }
    .status.err { background: #f0575714; border-color: #f0575740; color: var(--danger); }
    .status.err .dot { background: var(--danger); }
    .status.live { background: #f5c84214; border-color: #f5c84240; color: var(--warning); }
    .status.live .dot { background: var(--warning); animation: blink 1.2s infinite; }

    /* QR */
    .qr-wrap { display: flex; flex-direction: column; align-items: center; gap: 1.25rem; }
    .qr-box { background: #fff; border-radius: 14px; padding: 1.1rem; box-shadow: 0 0 50px var(--green-glow); }
    #qrcode canvas, #qrcode img { display: block; border-radius: 6px; }
    .qr-meta { text-align: center; }
    .qr-meta p { font-size: .83rem; color: var(--muted); line-height: 1.7; }
    .qr-meta strong { color: var(--text); }
    .timer-badge {
      display: inline-flex; align-items: center; gap: .4rem;
      padding: .3rem .75rem; background: var(--surface);
      border: 1px solid var(--border); border-radius: 99px;
      font-family: 'DM Mono', monospace; font-size: .75rem; color: var(--warning); margin-top: .5rem;
    }

    /* INFO BOX */
    .info-box {
      background: #4dc8f510; border: 1px solid #4dc8f530; border-radius: 10px;
      padding: .75rem 1rem; font-size: .75rem; color: #7dd8f7;
      font-family: 'DM Mono', monospace; margin-top: .75rem; line-height: 1.7;
    }
    .info-box b { color: #a0e4ff; }
    .info-box code { background: #ffffff10; padding: .1rem .35rem; border-radius: 4px; font-size: .7rem; word-break: break-all; }

    /* CORS HELP */
    .cors-help {
      background: #f5c84210; border: 1px solid #f5c84240; border-radius: 10px;
      padding: .85rem 1rem; font-size: .76rem; color: var(--warning);
      font-family: 'DM Mono', monospace; margin-bottom: 1rem; line-height: 1.75;
    }
    .cors-help b { color: #f8d96a; }
    .cors-help code { background: #ffffff10; padding: .1rem .35rem; border-radius: 4px; font-size: .7rem; }

    /* SUCCESS */
    .check-wrap {
      width: 240px; height: 240px;
      display: flex; align-items: center; justify-content: center;
      background: #f0fdf4; border-radius: 6px;
    }
    .check-wrap svg { width: 90px; height: 90px; }

    .footer { margin-top: 1.5rem; text-align: center; font-size: .72rem; color: var(--muted); opacity: .45; animation: fadeUp .6s ease .3s both; }

    .hidden { display: none !important; }

    @keyframes fadeDown { from { opacity:0; transform:translateY(-14px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeUp   { from { opacity:0; transform:translateY(14px);  } to { opacity:1; transform:translateY(0); } }
    @keyframes blink    { 0%,100%{opacity:1;} 50%{opacity:.25;} }
    @keyframes spin     { to{transform:rotate(360deg);} }
  </style>
</head>
<body>
<div class="grid"></div>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <div class="brand-icon">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51a12.6 12.6 0 00-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      </div>
      <span class="brand-name">Conectar WhatsApp</span>
    </div>
    <p class="subtitle">Escaneie o QR Code para vincular seu n√∫mero<br>a esta inst√¢ncia UAZAPI.</p>
  </div>

  <!-- STATUS -->
  <div class="status hidden" id="statusBar">
    <div class="dot"></div>
    <span id="statusText"></span>
  </div>

  <!-- CORS HELP -->
  <div class="cors-help hidden" id="corsHelp">
    ‚ö†Ô∏è <b>Bloqueio de CORS detectado.</b><br><br>
    O navegador impediu a requisi√ß√£o porque esta p√°gina est√° em <code>github.io (HTTPS)</code> e a API precisa permitir esse origin.<br><br>
    <b>Como resolver no painel UAZAPI:</b><br>
    Nas configura√ß√µes da inst√¢ncia, adicione o origin:<br>
    <code>https://rlucio01.github.io</code><br><br>
    Ou acesse esta p√°gina pelo mesmo dom√≠nio da sua API.
  </div>

  <!-- CONFIG CARD -->
  <div class="card" id="configCard">
    <div class="card-label">‚öô Configura√ß√£o da inst√¢ncia</div>
    <div class="field">
      <label>URL Base da API</label>
      <input id="apiUrl" type="text" placeholder="https://free.uazapi.com" autocomplete="off" />
    </div>
    <div class="field">
      <label>Token da Inst√¢ncia</label>
      <input id="apiToken" type="password" placeholder="e526fbf9-7a04-4693-..." autocomplete="off" />
    </div>
    <button class="btn btn-primary" id="btnGo" onclick="iniciar()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
      Gerar QR Code
    </button>
    <div class="info-box" id="linkHint">
      üí° <b>Compartilhe o link j√° configurado:</b><br>
      <code id="urlExample"></code>
    </div>
  </div>

  <!-- QR CARD -->
  <div class="card hidden" id="qrCard">
    <div class="card-label">üì± Escaneie com o WhatsApp</div>
    <div class="qr-wrap">
      <div class="qr-box"><div id="qrcode"></div></div>
      <div class="qr-meta">
        <p>Abra o WhatsApp ‚Üí <strong>Configura√ß√µes</strong><br>‚Üí <strong>Aparelhos conectados</strong> ‚Üí <strong>Conectar aparelho</strong></p>
        <div class="timer-badge hidden" id="timerBadge">‚è± Expira em <span id="countdown">60</span>s</div>
      </div>
    </div>
    <button class="btn btn-ghost" onclick="refreshQR()">‚Üª Atualizar QR Code</button>
    <button class="btn btn-ghost" onclick="voltarConfig()">‚Üê Alterar configura√ß√µes</button>
  </div>

  <div class="footer">Powered by UAZAPI ¬∑ GitHub Pages</div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Estado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let apiUrl = '', apiToken = '';
let qrObj = null, timerInt = null, pollInt = null, secsLeft = 60;

// ‚îÄ‚îÄ‚îÄ Inicializa√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  const p = new URLSearchParams(location.search);
  const urlParam   = p.get('url')   || p.get('api')   || '';
  const tokenParam = p.get('token') || p.get('t')     || '';

  let saved = {};
  try { saved = JSON.parse(localStorage.getItem('uaz_cfg') || '{}'); } catch {}

  document.getElementById('apiUrl').value   = urlParam   || saved.url   || '';
  document.getElementById('apiToken').value = tokenParam || saved.token || '';

  // Montar link de exemplo
  const base = location.href.split('?')[0];
  document.getElementById('urlExample').textContent =
    `${base}?url=https://free.uazapi.com&token=SEU_TOKEN`;

  // Se vier na URL, inicia automaticamente
  if (urlParam && tokenParam) setTimeout(iniciar, 400);
});

// ‚îÄ‚îÄ‚îÄ Helpers de UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(tipo, msg) {
  const bar = document.getElementById('statusBar');
  bar.className = `status ${tipo}`;
  bar.classList.remove('hidden');
  document.getElementById('statusText').textContent = msg;
}

// ‚îÄ‚îÄ‚îÄ Requisi√ß√£o com timeout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiFetch(url, opts = {}) {
  const ctrl = new AbortController();
  const tid  = setTimeout(() => ctrl.abort(), 12000);
  try {
    const r = await fetch(url, { ...opts, signal: ctrl.signal });
    clearTimeout(tid);
    return r;
  } catch (e) {
    clearTimeout(tid);
    throw e;
  }
}

// ‚îÄ‚îÄ‚îÄ Headers UAZAPI v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A UAZAPI v2 (free.uazapi.com) autentica via header "token"
function hdrs() {
  return {
    'Content-Type': 'application/json',
    'token': apiToken,
  };
}

function base() { return apiUrl.replace(/\/+$/, ''); }

// ‚îÄ‚îÄ‚îÄ Extrair QR de qualquer formato de resposta ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function extrairQR(data) {
  if (typeof data === 'string' && data.length > 20 && !data.startsWith('<'))
    return { tipo: 'str', val: data };

  const caminhos = [
    data?.qrcode, data?.qr, data?.qrCode, data?.code,
    data?.data?.qrcode, data?.data?.qr, data?.data?.qrCode,
    data?.instance?.qr, data?.instance?.qrCode,
    data?.result?.qr, data?.result?.qrCode,
    data?.base64, data?.data?.base64,
  ];

  for (const c of caminhos) {
    if (!c || typeof c !== 'string') continue;
    if (c.startsWith('data:image')) return { tipo: 'img', val: c };
    if (c.length > 20) return { tipo: 'str', val: c };
  }
  return null;
}

// ‚îÄ‚îÄ‚îÄ Tentar todos endpoints conhecidos da UAZAPI v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function buscarQR() {
  const b = base();

  // Endpoints da UAZAPI v2 em ordem de probabilidade
  const tentativas = [
    { method: 'GET',  url: `${b}/instance/connect`     },
    { method: 'GET',  url: `${b}/instance/qrcode`      },
    { method: 'POST', url: `${b}/instance/connect`, body: '{}' },
    { method: 'GET',  url: `${b}/qrcode`               },
    { method: 'GET',  url: `${b}/connect`              },
    { method: 'POST', url: `${b}/connect`,          body: '{}' },
  ];

  let ultimoErro = null;

  for (const t of tentativas) {
    try {
      const r = await apiFetch(t.url, {
        method: t.method,
        headers: hdrs(),
        ...(t.body ? { body: t.body } : {}),
      });

      const text = await r.text();
      let data;
      try { data = JSON.parse(text); } catch { data = text; }

      const qr = extrairQR(data);
      if (qr) {
        console.log('‚úÖ QR encontrado em:', t.method, t.url);
        return qr;
      }

      console.warn('‚ö†Ô∏è Sem QR em:', t.method, t.url, '‚Üí status', r.status);
    } catch (e) {
      ultimoErro = e;
      console.warn('‚ùå Erro em:', t.url, e.message);
    }
  }

  throw ultimoErro || new Error('Nenhum endpoint retornou QR Code.');
}

// ‚îÄ‚îÄ‚îÄ Renderizar QR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderizarQR(qr) {
  const container = document.getElementById('qrcode');
  container.innerHTML = '';

  if (qr.tipo === 'img') {
    const img = document.createElement('img');
    img.src   = qr.val;
    img.style.cssText = 'width:240px;height:240px;border-radius:6px;display:block;';
    container.appendChild(img);
  } else {
    if (qrObj) { try { qrObj.clear(); } catch {} }
    qrObj = new QRCode(container, {
      text: qr.val, width: 240, height: 240,
      colorDark: '#000000', colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M,
    });
  }

  // Timer regressivo
  secsLeft = 60;
  const badge     = document.getElementById('timerBadge');
  const countdown = document.getElementById('countdown');
  badge.classList.remove('hidden');
  countdown.textContent = secsLeft;
  clearInterval(timerInt);
  timerInt = setInterval(() => {
    secsLeft--;
    countdown.textContent = secsLeft;
    if (secsLeft <= 0) { clearInterval(timerInt); refreshQR(); }
  }, 1000);
}

// ‚îÄ‚îÄ‚îÄ INICIAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function iniciar() {
  apiUrl   = document.getElementById('apiUrl').value.trim();
  apiToken = document.getElementById('apiToken').value.trim();

  if (!apiUrl || !apiToken) { alert('Preencha a URL da API e o Token.'); return; }
  if (!apiUrl.startsWith('http')) apiUrl = 'https://' + apiUrl;

  try { localStorage.setItem('uaz_cfg', JSON.stringify({ url: apiUrl, token: apiToken })); } catch {}

  document.getElementById('corsHelp').classList.add('hidden');
  document.getElementById('btnGo').disabled = true;
  setStatus('loading', 'Conectando √† API UAZAPI‚Ä¶');

  try {
    const qr = await buscarQR();
    document.getElementById('configCard').classList.add('hidden');
    document.getElementById('qrCard').classList.remove('hidden');
    setStatus('ok', 'QR Code gerado com sucesso! Escaneie agora.');
    renderizarQR(qr);
    iniciarPolling();
  } catch (e) {
    document.getElementById('btnGo').disabled = false;

    const ehCors = (e instanceof TypeError) && (
      e.message === 'Failed to fetch' ||
      e.message.toLowerCase().includes('network') ||
      e.message.toLowerCase().includes('cors')
    );

    if (ehCors) {
      setStatus('err', 'Bloqueado por CORS ‚Äî veja instru√ß√£o abaixo.');
      document.getElementById('corsHelp').classList.remove('hidden');
    } else {
      setStatus('err', 'N√£o foi poss√≠vel obter o QR. Verifique URL e Token.');
    }
  }
}

// ‚îÄ‚îÄ‚îÄ ATUALIZAR QR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshQR() {
  clearInterval(timerInt);
  setStatus('loading', 'Atualizando QR Code‚Ä¶');
  try {
    const qr = await buscarQR();
    setStatus('ok', 'QR Code atualizado! Escaneie agora.');
    renderizarQR(qr);
  } catch {
    setStatus('err', 'Falha ao atualizar. Tente novamente.');
  }
}

// ‚îÄ‚îÄ‚îÄ POLLING DE STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function iniciarPolling() {
  clearInterval(pollInt);
  const endpoints = [
    `${base()}/instance/status`,
    `${base()}/instance/connectionState`,
    `${base()}/status`,
  ];
  let idx = 0;

  pollInt = setInterval(async () => {
    try {
      const url = endpoints[idx % endpoints.length]; idx++;
      const r   = await apiFetch(url, { headers: hdrs() });
      if (!r.ok) return;
      const data = await r.json().catch(() => null);
      if (!data) return;

      const st = (
        data?.state || data?.status || data?.connectionState ||
        data?.instance?.state || data?.instance?.status ||
        data?.data?.state || data?.data?.status || ''
      ).toString().toLowerCase();

      if (['open', 'connected', 'online', 'authenticated'].some(s => st.includes(s))) {
        clearInterval(pollInt); clearInterval(timerInt);
        setStatus('live', '‚úÖ WhatsApp conectado com sucesso!');
        document.getElementById('qrcode').innerHTML =
          `<div class="check-wrap">
            <svg viewBox="0 0 52 52" fill="none">
              <circle cx="26" cy="26" r="25" fill="#dcfce7" stroke="#25d366" stroke-width="2"/>
              <path d="M15 26l8 8 14-16" stroke="#25d366" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>`;
        document.getElementById('timerBadge').classList.add('hidden');
      }
    } catch {}
  }, 4000);
}

// ‚îÄ‚îÄ‚îÄ VOLTAR CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function voltarConfig() {
  clearInterval(pollInt); clearInterval(timerInt);
  document.getElementById('configCard').classList.remove('hidden');
  document.getElementById('qrCard').classList.add('hidden');
  document.getElementById('corsHelp').classList.add('hidden');
  document.getElementById('statusBar').classList.add('hidden');
  document.getElementById('btnGo').disabled = false;
}
</script>
</body>
</html>
